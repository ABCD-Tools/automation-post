=============================================================================
BUSINESS LOGIC - Post Automation Platform
=============================================================================

OVERVIEW
--------
A web-based platform that allows users to automatically post content to 
multiple social media accounts simultaneously using a local client agent 
that runs on their machine.

=============================================================================
CORE WORKFLOWS
=============================================================================

1. USER REGISTRATION & AUTHENTICATION
--------------------------------------
Input: Email, Password
Process:
  - User registers on website
  - Supabase creates user account
  - Supabase sends verification email
  - User clicks verification link
  - User is redirected to dashboard
Output: Authenticated user session

Business Rules:
  - Email must be unique
  - Password minimum 8 characters
  - Must verify email before using platform
  - Free tier: Max 3 social accounts
  - Premium: Unlimited accounts

=============================================================================

2. CLIENT INSTALLATION
----------------------
Input: Installation directory path (chosen in website)
Process:
  - User selects directory via browser file picker API
  - User clicks "Install Agent" button
  - Website generates installer download with embedded config:
    * User ID
    * API token
    * Installation path
    * API endpoint URL
  - User downloads installer.exe
  - User runs installer
  - Installer extracts to chosen directory
  - Installer registers yourapp:// protocol handler
  - Installer creates client record in database
Output: Installed client agent, registered in database

Business Rules:
  - Installation path must have write permissions
  - Only one agent per user per machine
  - Agent version tracked for updates
  - Each installation gets unique client_id

Database Changes:
  - INSERT into clients table:
    * user_id
    * client_id (UUID)
    * install_path
    * api_token (JWT, 90 days expiry)
    * platform, os_version
    * status: 'installed' (not yet running)
    * installed_at

=============================================================================

3. ADD SOCIAL MEDIA ACCOUNT
----------------------------
Input: Platform (instagram/facebook/twitter), Username, Password
Process:
  - User enters credentials in dashboard
  - Frontend encrypts password using Web Crypto API
  - Encrypted password sent to backend
  - Backend stores encrypted password in database
  - Backend creates job to verify account
  - Job added to queue (status: 'pending_verification')
  - User sees "Verifying account..." message
  - When agent wakes up and processes verification job:
    * Agent launches browser
    * Attempts login
    * If success: Extract and store cookies (encrypted)
    * If fail: Mark account as 'login_failed'
  - Dashboard updates account status
Output: Verified social account or error message

Business Rules:
  - Password encrypted client-side before transmission
  - Cookies stored encrypted in database
  - Account marked 'active' only after successful login verification
  - Failed login allows retry (button: "Re-verify Account")
  - Session cookies expire after 7 days (auto re-login needed)
  - Users can have multiple accounts per platform

Database Changes:
  - INSERT into accounts table:
    * user_id
    * platform
    * username
    * encrypted_password
    * status: 'pending_verification'
  - INSERT into jobs table:
    * job_type: 'verify_account'
    * account_id
    * status: 'pending'
  - After verification UPDATE accounts:
    * status: 'active' or 'login_failed'
    * encrypted_cookies (if success)
    * last_verified_at

=============================================================================

4. CREATE POST (AGENT SLEEPING)
--------------------------------
Input: Caption, Image file, Selected accounts
Process:
  - User uploads image
  - Image sent to Cloudinary
  - Cloudinary returns secure URL
  - User writes caption
  - User selects which accounts to post to (default: all)
  - User clicks "Post Now"
  - Dashboard checks agent status
  - Agent status: OFFLINE/SLEEPING
  - System creates job record (status: 'queued')
  - Dashboard shows modal:
    "Agent is sleeping. Wake it up to process this post?"
    [Wake Up Agent] [Queue for Later]
  - If user clicks "Wake Up Agent":
    * Open deep link: yourapp://start
    * Browser prompts to open agent
    * User approves
    * Agent launches
  - If user clicks "Queue for Later":
    * Job stays in queue
    * User can wake agent anytime from dashboard
Output: Job queued, waiting for agent

Business Rules:
  - Image max size: 10MB
  - Supported formats: JPG, PNG, WEBP
  - Caption max length: 2200 characters (Instagram limit)
  - Can queue multiple posts while agent is sleeping
  - Jobs expire after 7 days if not processed

Database Changes:
  - INSERT into jobs table:
    * user_id
    * job_type: 'post'
    * status: 'queued'
    * content: { caption, image_url }
    * target_accounts: [account_id1, account_id2, ...]
    * created_at
    * expires_at: created_at + 7 days

=============================================================================

5. AGENT WAKE UP & JOB PROCESSING
----------------------------------
Input: Deep link trigger (yourapp://start)
Process:
  - Agent.exe receives start command
  - Agent checks if already running (via lock file)
  - If already running: exit silently
  - If not running:
    * Create lock file with PID
    * Start polling loop (every 10 seconds)
    * Update client status in database: 'online'
  - Agent polls API: GET /api/client/jobs/pending
  - API returns jobs for this user (status: 'queued')
  - For each job:
    * Update job status: 'processing'
    * For each target account:
      - Load account credentials
      - Decrypt password/cookies
      - Launch Puppeteer browser
      - Execute workflow (login if needed, post content)
      - Capture post URL from platform
      - Update job result for this account
    * After all accounts processed:
      - Update job status: 'completed' or 'partial' or 'failed'
  - After 5 minutes of no jobs (idle):
    * Agent auto-sleeps
    * Update client status: 'sleeping'
    * Delete lock file
    * Exit process
Output: Posts published, job results stored

Business Rules:
  - Agent only processes jobs for its authenticated user
  - Maximum 5 jobs processed per polling cycle
  - If browser automation fails 3 times, mark account 'needs_reauth'
  - Each post attempt logged with timestamp
  - Failed posts can be retried manually

Database Changes:
  - UPDATE clients:
    * status: 'online'
    * last_seen: now()
  - UPDATE jobs:
    * status: 'processing' → 'completed'/'failed'
    * processed_at
    * results: [
        { account_id, success: true/false, post_url, error }
      ]
  - UPDATE accounts:
    * last_used_at (if posted successfully)
    * status: 'needs_reauth' (if login failed)
  - UPDATE clients (after 5 min idle):
    * status: 'sleeping'

=============================================================================

6. POST CONTENT DETECTION & FLAGS
----------------------------------
Process (after each post attempt):
  - Check if cookies expired during posting
    * If yes: Flag account for re-authentication
  - Check if rate limited by platform
    * If yes: Set cooldown timestamp (1 hour)
  - Check image hash against recent posts (7 days)
    * If similar (>95%): Warning flag for duplicate
  - Check caption for URLs
    * If found: Info flag about reduced reach
  - All flags saved to job results
Output: Flags displayed in dashboard post results

Business Rules:
  - Cookie expiry = automatic re-auth required
  - Rate limit cooldown prevents posting for 1 hour
  - Duplicate warnings don't block posting
  - URL warnings are informational only

=============================================================================

7. DASHBOARD REAL-TIME UPDATES
-------------------------------
Process:
  - While job is processing, dashboard polls:
    GET /api/jobs/{jobId}/status (every 2 seconds)
  - API returns current job status and results
  - Frontend updates UI progressively:
    * "Processing account 1/3..."
    * "✅ Instagram posted"
    * "❌ Facebook failed: Rate limited"
Output: Live progress display

Business Rules:
  - Polling stops when job status is 'completed' or 'failed'
  - Maximum 60 seconds of polling (timeout protection)
  - If agent crashes mid-job, job marked 'stalled' after 5 min

=============================================================================
DEVELOPER WORKFLOWS (SUPERADMIN ONLY)
=============================================================================

8. CREATE MICRO-ACTION
-----------------------
Input: Action name, type, platform, parameters
Process:
  - Superadmin defines atomic browser action
  - Examples:
    * Type: "click"
      Params: { selector: "button[type=submit]" }
    * Type: "type"
      Params: { selector: "input[name=username]", text: "{{username}}" }
    * Type: "wait"
      Params: { duration: 2000, randomize: true }
  - Micro-action saved to database
  - Available for use in workflows
Output: Reusable micro-action

Business Rules:
  - Only superadmin can create/edit micro-actions
  - Parameters can use template variables: {{username}}, {{password}}
  - Each micro-action has unique ID
  - Versioned (can update without breaking existing workflows)

Database Changes:
  - INSERT into micro_actions:
    * name, description, type, platform
    * params (JSON)
    * created_by (superadmin user_id)

=============================================================================

9. BUILD WORKFLOW (ACTION)
---------------------------
Input: Workflow name, platform, list of micro-action steps
Process:
  - Superadmin creates workflow (e.g., "Instagram Login")
  - Adds micro-actions in sequence:
    1. Navigate to login page
    2. Wait for username field
    3. Type username
    4. Wait 2 seconds
    5. Type password
    6. Click login button
    7. Wait for navigation
  - Workflow saved to database
  - Agent executes workflows step-by-step
Output: Executable workflow

Business Rules:
  - Workflows are platform-specific
  - Each step references a micro-action by ID
  - Can override micro-action params in workflow
  - Workflows can call other workflows (e.g., "Post" workflow calls "Login" workflow first)

Database Changes:
  - INSERT into workflows:
    * name, platform, type (auth/post/etc)
    * steps: [
        { micro_action_id, params: {...} }
      ]
    * requires_auth: true/false
    * auth_workflow_id (reference to login workflow)

=============================================================================
BUSINESS RULES SUMMARY
=============================================================================

FREE TIER LIMITS:
- Max 3 social media accounts
- Max 10 posts per day
- Single agent installation
- 7-day job retention

PREMIUM TIER (Future):
- Unlimited accounts
- Unlimited posts
- Multiple agents (home + work PC)
- 90-day job retention
- Priority support
- Analytics dashboard

SECURITY:
- All passwords encrypted in transit and at rest
- API tokens expire after 90 days
- Session cookies encrypted in database
- Agent only accesses user's own data
- Deep links require user approval

RELIABILITY:
- Jobs expire after 7 days
- Agent auto-sleeps after 5 min idle
- Failed jobs can be retried
- Stalled jobs marked after 5 min
- Accounts auto-flagged for re-auth if cookies expire

=============================================================================