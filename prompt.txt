# Fixing Vercel Serverless Directory Creation Error

## üö® The Problem

**Error:** `ENOENT: no such file or directory, mkdir '/vercel'`

**Why it happens:** Vercel serverless functions have a **read-only filesystem** except for the `/tmp` directory. Any attempt to create directories outside `/tmp` will fail.

## üîç Root Cause

Build functions using relative paths like `path.join(__dirname, '../../.temp/...')` resolve to paths outside the writable `/tmp` directory in Vercel's serverless environment.

---

## ‚úÖ Solution 1: Use /tmp Directory (RECOMMENDED)

Modify build functions to use `/tmp` as the base directory for all temporary file operations.

### Files to Update:

**`src/modules-installer/developer-zip-builder.mjs` (line 197):**
```javascript
// ‚ùå BEFORE
const buildDir = path.join(__dirname, '../../.temp/developer-zip-build');

// ‚úÖ AFTER
const buildDir = path.join(process.env.TMPDIR || '/tmp', 'developer-zip-build');
```

**`src/modules-installer/builder.mjs` (line 46):**
```javascript
// ‚ùå BEFORE
const buildDir = path.join(__dirname, '../../.temp/installer-build');

// ‚úÖ AFTER
const buildDir = path.join(process.env.TMPDIR || '/tmp', 'installer-build');
```

**`src/modules-installer/installer-builder.mjs` (line 32):**
```javascript
// ‚ùå BEFORE
const buildDir = path.join(__dirname, '../../.temp/installer-exe-build');

// ‚úÖ AFTER
const buildDir = path.join(process.env.TMPDIR || '/tmp', 'installer-exe-build');
```

### Benefits:
- ‚úÖ Works in all serverless environments (Vercel, AWS Lambda, etc.)
- ‚úÖ Uses the only writable directory available
- ‚úÖ No filesystem permission issues

---

## üåê Solution 2: Use os.tmpdir() for Cross-Platform Compatibility

Use Node.js's built-in `os.tmpdir()` which automatically returns the correct temporary directory.

```javascript
import os from 'os';
import path from 'path';

const buildDir = path.join(os.tmpdir(), 'developer-zip-build');
```

### Benefits:
- ‚úÖ Works on all platforms (Windows, Linux, macOS)
- ‚úÖ Automatically uses the correct temp directory
- ‚úÖ More portable code

---

## üîß Solution 3: Add Environment Detection

Detect if running in Vercel/serverless and use appropriate directory.

```javascript
import os from 'os';

function getTempDir() {
  // Check if running in Vercel
  if (process.env.VERCEL || process.env.VERCEL_ENV) {
    return '/tmp';
  }
  // Check if TMPDIR is set (common in serverless)
  if (process.env.TMPDIR) {
    return process.env.TMPDIR;
  }
  // Fall back to os.tmpdir() for local development
  return os.tmpdir();
}

const buildDir = path.join(getTempDir(), 'developer-zip-build');
```

### Benefits:
- ‚úÖ Explicit handling of different environments
- ‚úÖ Works in both local development and production
- ‚úÖ Clear intent in code

---

## üéØ Solution 4: Use Unique Subdirectories to Avoid Conflicts

Since `/tmp` is shared, use unique subdirectories per request to prevent conflicts.

```javascript
import { v4 as uuidv4 } from 'uuid';
import os from 'os';
import path from 'path';

const tempBase = process.env.TMPDIR || os.tmpdir();
const uniqueId = uuidv4();
const buildDir = path.join(tempBase, `abcd-tools-build-${uniqueId}`);
```

### Benefits:
- ‚úÖ Prevents file conflicts between concurrent requests
- ‚úÖ Easier cleanup (can identify your files)
- ‚úÖ More robust in multi-tenant environments

---

## üèÜ RECOMMENDED: Combined Implementation

Combine Solutions 2 and 4 for the best result:

```javascript
import os from 'os';
import { v4 as uuidv4 } from 'uuid';
import path from 'path';

function getBuildDir(prefix = 'build') {
  const tempBase = process.env.TMPDIR || os.tmpdir();
  const uniqueId = uuidv4();
  return path.join(tempBase, `abcd-tools-${prefix}-${uniqueId}`);
}

// Usage:
const buildDir = getBuildDir('developer-zip');
await fs.mkdir(buildDir, { recursive: true });
```

### This ensures:
- ‚úÖ Works in Vercel serverless environment
- ‚úÖ Works in local development
- ‚úÖ Prevents file conflicts
- ‚úÖ Cross-platform compatible
- ‚úÖ Easy to identify and clean up

---

## ‚ö†Ô∏è Additional Considerations

### 1. Cleanup
Always clean up temporary files after use to avoid filling up `/tmp`:

```javascript
try {
  // Your build operations
  await buildFiles(buildDir);
} finally {
  // Cleanup
  await fs.rm(buildDir, { recursive: true, force: true });
}
```

### 2. File Size Limits
Vercel has limits on `/tmp` usage:
- Monitor file sizes
- Consider streaming large files instead of storing them

### 3. Concurrent Requests
Multiple requests may run simultaneously:
- Use unique directory names per request (Solution 4)
- Avoid shared state in `/tmp`

### 4. Error Handling
Wrap mkdir calls in try-catch:

```javascript
try {
  await fs.mkdir(buildDir, { recursive: true });
} catch (error) {
  if (error.code !== 'EEXIST') {
    throw error;
  }
}
```

---

## üìã Quick Implementation Checklist

- [ ] Update all `buildDir` paths to use `/tmp` or `os.tmpdir()`
- [ ] Add unique ID generation for concurrent request safety
- [ ] Implement cleanup in `finally` blocks
- [ ] Add proper error handling for mkdir operations
- [ ] Test in both local and Vercel environments
- [ ] Monitor `/tmp` usage in production

---

## üîó Related Resources

- [Vercel Serverless Functions Documentation](https://vercel.com/docs/functions/serverless-functions)
- [Node.js os.tmpdir() API](https://nodejs.org/api/os.html#ostmpdir)
- [Vercel Runtime Limits](https://vercel.com/docs/functions/serverless-functions/runtimes)